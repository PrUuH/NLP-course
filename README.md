**Чё было попробовано для второй лабы**

## 1. Оптимизация промптов

### 1.1. Русские промпты с JSON-форматом
- **Затестил промпты на английском - не залетело, перекат обратно на русский**
- **Строгий формат ответа**: `{"category": "<категория>"}`
- **Чёткие инструкции**: выбрать ровно одну категорию, без дополнительного текста

### 1.2. Варианты промптов (версии 1–3) - добавил в последнюю очередь, сработало плохо
- **Версия 1**: строгий JSON-промпт с акцентом на формат
- **Версия 2**: разговорный стиль, запрет на придумывание категорий
- **Версия 3**: упрощённый, прямой промпт

### 1.3. Few-shot примеры
- **Автоматическое добавление примеров** для каждой категории
- **Примеры берутся из обучающей выборки** (`examples_by_categories`)

## 2. Постобработка ответов модели

### 2.1. Парсинг JSON-ответов (`parse_llm_output`)
- Попытка `json.loads()`
- **Регулярки**: `r'"category"\s*:\s*"([^"]+)"'`
- **Fuzzy matching** через fuzzywuzzy (fallback)

### 2.2. Нормализация категорий (`map_to_category`)
- Точное совпадение
- **Маппинг по ключевым словам** (`category_aliases`)
- Fuzzy matching как последний fallback

### 2.3. Дополнительная нормализация (`normalize_and_map`)
- Нормализация пробелов и слэшей
- Проверка по ключевым словам для каждой категории
- Fallback на самую частую категорию

## 3. Настройка параметров генерации

### 3.1. Параметры модели - сильно не исправляли ситуацию
- `max_new_tokens` 
- `temperature` 
- `top_p` 
- `do_sample`

## 4. Ансамблирование

### 4.1. Ансамбль по промптам
- Запуск модели с тремя версиями промптов для каждого текста
- **Умное голосование** (`smart_majority_vote`):
  - Постобработка каждого ответа перед голосованием
  - Если 2 из 3 согласны - берётся этот ответ
  - Если все 3 разные - выбор по ключевым словам в тексте

### 4.2. Выбор лучшего промпта
- Оценка каждого промпта отдельно на валидации
- **Выбор промпта с максимальным macro F1** - мало зарешало, разница в F1 была минимальной

## 5. Коррекция ошибок на основе данных

### 5.1. Правила коррекции (`apply_confusion_correction`)
- Исправление частых путаниц (например, `health` и `science/technology`)
- Проверка ключевых слов в тексте для переклассификации

## 6. Использование ключевых слов

### 6.1. Словарь синонимов (`category_aliases`)
- Маппинг ключевых слов на категории
- Поддержка русского и английского

### 6.2. Интеграция ключевых слов в голосование
- При равных голосах выбор по совпадениям ключевых слов в тексте

## Выводы
- **Ансамблирование** не всегда улучшает результат, если промпты дают разные ошибки
- **Постобработка** важна для исправления формата ответов модели
- **Лучший результат** даёт один хорошо настроенный промпт с постобработкой, а не ансамбль
